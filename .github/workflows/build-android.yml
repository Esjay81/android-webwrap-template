name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: "App Name"
        required: true
        type: string
      package_id:
        description: "Package ID"
        required: true
        type: string
      web_app_url:
        description: "Web App URL"
        required: true
        type: string
      version_name:
        description: "Version Name"
        required: true
        type: string
        default: "1.0.0"
      version_code:
        description: "Version Code"
        required: true
        type: string
        default: "1"
      app_logo_url:
        description: "App Logo URL"
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: "17"
        distribution: "temurin"
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Configure app parameters
      run: |
        # Replace placeholders in build.gradle
        sed -i "s|{{PACKAGE_ID}}|${{ inputs.package_id }}|g" app/build.gradle
        sed -i "s|{{VERSION_CODE}}|${{ inputs.version_code }}|g" app/build.gradle
        sed -i "s|{{VERSION_NAME}}|${{ inputs.version_name }}|g" app/build.gradle
        
        # Replace placeholders in MainActivity.kt
        sed -i "s|{{PACKAGE_ID}}|${{ inputs.package_id }}|g" app/src/main/java/com/webwrap/app/MainActivity.kt
        sed -i "s|{{WEB_APP_URL}}|${{ inputs.web_app_url }}|g" app/src/main/java/com/webwrap/app/MainActivity.kt
        
        # Replace placeholders in strings.xml
        sed -i "s|{{APP_NAME}}|${{ inputs.app_name }}|g" app/src/main/res/values/strings.xml
        
        # Update package structure
        mkdir -p "app/src/main/java/$(echo ${{ inputs.package_id }} | tr '.' '/')"
        mv app/src/main/java/com/webwrap/app/MainActivity.kt "app/src/main/java/$(echo ${{ inputs.package_id }} | tr '.' '/')/"
        
    - name: Make gradlew executable
      run: chmod +x ./gradlew
      
    - name: Build with Gradle
      run: ./gradlew assembleRelease
      
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 30
